<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DataWhisper ‚Äî Talk to Your Data</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --transition: 0.3s ease;
    }

    [data-theme="dark"] {
      --bg: #060810;
      --bg2: #0c0f1a;
      --surface: #111827;
      --surface2: #1a2235;
      --surface3: #1f2a40;
      --border: #1e2d45;
      --border2: #253550;
      --accent: #6366f1;
      --accent-glow: rgba(99,102,241,0.3);
      --accent2: #22d3ee;
      --accent3: #10b981;
      --text: #f0f4ff;
      --text2: #8b9abd;
      --text3: #3d4f6e;
      --danger: #f43f5e;
      --card-shadow: 0 4px 24px rgba(0,0,0,0.4);
      --glow: 0 0 40px rgba(99,102,241,0.15);
    }

    [data-theme="light"] {
      --bg: #f5f7ff;
      --bg2: #eef1fa;
      --surface: #ffffff;
      --surface2: #f0f3ff;
      --surface3: #e8ecf8;
      --border: #dde3f5;
      --border2: #c8d0ea;
      --accent: #4f46e5;
      --accent-glow: rgba(79,70,229,0.15);
      --accent2: #0891b2;
      --accent3: #059669;
      --text: #0f172a;
      --text2: #4a5680;
      --text3: #9aa5c4;
      --danger: #e11d48;
      --card-shadow: 0 4px 24px rgba(79,70,229,0.08);
      --glow: 0 0 40px rgba(79,70,229,0.08);
    }

    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'Space Grotesk', sans-serif; transition: background var(--transition), color var(--transition); }

    /* Animated gradient bg */
    body::before {
      content: '';
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background: radial-gradient(ellipse 80% 50% at 20% -10%, rgba(99,102,241,0.12) 0%, transparent 60%),
                  radial-gradient(ellipse 60% 40% at 80% 110%, rgba(34,211,238,0.08) 0%, transparent 60%);
    }

    [data-theme="light"] body::before {
      background: radial-gradient(ellipse 80% 50% at 20% -10%, rgba(79,70,229,0.06) 0%, transparent 60%),
                  radial-gradient(ellipse 60% 40% at 80% 110%, rgba(8,145,178,0.05) 0%, transparent 60%);
    }

    #root { position: relative; z-index: 1; height: 100%; display: flex; flex-direction: column; }

    /* ---- HEADER ---- */
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; height: 60px;
      border-bottom: 1px solid var(--border);
      background: rgba(6,8,16,0.8); backdrop-filter: blur(20px);
      position: sticky; top: 0; z-index: 100;
      transition: background var(--transition);
    }
    [data-theme="light"] header { background: rgba(255,255,255,0.85); }

    .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .logo-mark {
      width: 34px; height: 34px; border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; box-shadow: 0 0 20px var(--accent-glow);
    }
    .logo-name { font-family: 'Outfit', sans-serif; font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
    .logo-name em { color: var(--accent2); font-style: normal; }

    .header-right { display: flex; align-items: center; gap: 12px; }
    .header-pill {
      font-family: 'JetBrains Mono', monospace; font-size: 10px;
      color: var(--text2); border: 1px solid var(--border);
      border-radius: 20px; padding: 5px 12px;
      background: var(--surface2);
    }

    /* Theme toggle */
    .theme-toggle {
      width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border);
      background: var(--surface2); cursor: pointer; display: flex; align-items: center;
      justify-content: center; font-size: 16px; transition: all 0.2s;
      color: var(--text2);
    }
    .theme-toggle:hover { border-color: var(--accent); background: var(--surface3); color: var(--text); }

    /* ---- LAYOUT ---- */
    .app-body { flex: 1; display: grid; grid-template-columns: 280px 1fr; overflow: hidden; }

    /* ---- SIDEBAR ---- */
    .sidebar {
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column; overflow-y: auto;
      background: var(--surface); transition: background var(--transition);
    }
    .sidebar::-webkit-scrollbar { width: 3px; }
    .sidebar::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

    .sidebar-section { padding: 16px; border-bottom: 1px solid var(--border); }
    .sidebar-label {
      font-family: 'JetBrains Mono', monospace; font-size: 9px;
      text-transform: uppercase; letter-spacing: 2px; color: var(--text3);
      margin-bottom: 12px; display: flex; align-items: center; gap: 6px;
    }

    /* Upload */
    .upload-zone {
      border: 1.5px dashed var(--border2); border-radius: 12px;
      padding: 28px 16px; text-align: center; cursor: pointer;
      transition: all 0.2s; position: relative; overflow: hidden;
      background: var(--surface2);
    }
    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--accent); background: var(--accent-glow);
      box-shadow: inset 0 0 20px var(--accent-glow);
    }
    .upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .upload-icon { font-size: 32px; margin-bottom: 10px; display: block; }
    .upload-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; color: var(--text); }
    .upload-sub { font-size: 11px; color: var(--text2); }

    /* File info */
    .file-info {
      background: linear-gradient(135deg, var(--surface2), var(--surface3));
      border-radius: 12px; padding: 14px; border: 1px solid var(--border2);
      box-shadow: var(--card-shadow);
    }
    .file-icon-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .file-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent3); flex-shrink: 0; box-shadow: 0 0 8px var(--accent3); }
    .file-name { font-size: 13px; font-weight: 600; word-break: break-all; flex: 1; }
    .file-meta { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
    .file-tag {
      font-family: 'JetBrains Mono', monospace; font-size: 10px;
      padding: 3px 8px; border-radius: 6px;
      background: var(--bg); color: var(--accent2);
      border: 1px solid var(--border2);
    }
    .file-change { font-size: 11px; color: var(--text3); cursor: pointer; transition: color 0.2s; display: inline-flex; align-items: center; gap: 4px; }
    .file-change:hover { color: var(--accent); }

    /* Columns */
    .col-list { display: flex; flex-direction: column; gap: 4px; }
    .col-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 7px 10px; background: var(--surface2); border-radius: 8px;
      border: 1px solid var(--border); transition: all 0.15s;
    }
    .col-item:hover { border-color: var(--accent); background: var(--surface3); }
    .col-name { font-size: 12px; font-weight: 500; }
    .col-badge {
      font-family: 'JetBrains Mono', monospace; font-size: 9px;
      padding: 2px 6px; border-radius: 4px;
      background: rgba(99,102,241,0.15); color: var(--accent);
      border: 1px solid rgba(99,102,241,0.2);
    }

    /* Suggestions */
    .suggestions { display: flex; flex-direction: column; gap: 6px; }
    .suggestion-btn {
      text-align: left; background: var(--surface2); border: 1px solid var(--border);
      border-radius: 10px; padding: 10px 12px; cursor: pointer;
      font-size: 12px; color: var(--text2); transition: all 0.2s;
      font-family: 'Space Grotesk', sans-serif; font-weight: 500;
      display: flex; align-items: flex-start; gap: 8px;
    }
    .suggestion-btn:hover { border-color: var(--accent); color: var(--text); background: var(--accent-glow); transform: translateX(2px); }
    .suggestion-arrow { color: var(--accent); flex-shrink: 0; opacity: 0; transition: opacity 0.2s; }
    .suggestion-btn:hover .suggestion-arrow { opacity: 1; }

    /* ---- CHAT ---- */
    .chat-area { display: flex; flex-direction: column; overflow: hidden; background: var(--bg); transition: background var(--transition); }

    /* Empty */
    .empty-state {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      text-align: center; padding: 40px 24px;
    }
    .empty-orb {
      width: 100px; height: 100px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      display: flex; align-items: center; justify-content: center;
      font-size: 44px; margin-bottom: 28px;
      box-shadow: 0 0 60px var(--accent-glow), 0 0 120px var(--accent-glow);
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-12px); } }
    .empty-title { font-family: 'Outfit', sans-serif; font-size: 36px; font-weight: 900; margin-bottom: 12px; line-height: 1.1; letter-spacing: -1px; }
    .empty-title span { background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .empty-sub { font-size: 15px; color: var(--text2); max-width: 380px; line-height: 1.7; margin-bottom: 32px; }
    .empty-upload {
      border: 1.5px dashed var(--border2); border-radius: 16px;
      padding: 24px 40px; cursor: pointer; transition: all 0.2s;
      background: var(--surface); position: relative; overflow: hidden;
    }
    .empty-upload:hover { border-color: var(--accent); box-shadow: 0 0 30px var(--accent-glow); }
    .empty-upload input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .empty-upload-text { font-size: 14px; font-weight: 600; color: var(--text2); }
    .empty-upload-text span { color: var(--accent); }

    /* Messages */
    .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 18px; }
    .messages::-webkit-scrollbar { width: 3px; }
    .messages::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

    .msg { display: flex; gap: 10px; animation: slideUp 0.3s ease forwards; }
    .msg.user { flex-direction: row-reverse; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }

    .msg-avatar {
      width: 32px; height: 32px; border-radius: 10px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center; font-size: 14px;
    }
    .msg.user .msg-avatar { background: linear-gradient(135deg, var(--accent), var(--accent2)); box-shadow: 0 0 16px var(--accent-glow); }
    .msg.ai .msg-avatar { background: var(--surface2); border: 1px solid var(--border2); }

    .msg-content { max-width: 78%; display: flex; flex-direction: column; gap: 8px; }
    .msg.user .msg-content { align-items: flex-end; }

    .msg-bubble {
      padding: 12px 16px; border-radius: 14px; font-size: 14px; line-height: 1.7;
    }
    .msg.user .msg-bubble {
      background: linear-gradient(135deg, rgba(99,102,241,0.25), rgba(34,211,238,0.15));
      border: 1px solid rgba(99,102,241,0.3);
    }
    .msg.ai .msg-bubble {
      background: var(--surface); border: 1px solid var(--border2);
      box-shadow: var(--card-shadow);
    }

    /* Code */
    .code-block { background: var(--bg2); border: 1px solid var(--border2); border-radius: 10px; overflow: hidden; width: 100%; }
    .code-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 14px; background: var(--surface3); cursor: pointer; transition: background 0.15s; }
    .code-header:hover { background: var(--surface2); }
    .code-label { font-family: 'JetBrains Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text2); }
    .copy-btn { font-size: 11px; color: var(--text2); cursor: pointer; background: none; border: 1px solid var(--border); border-radius: 5px; font-family: 'JetBrains Mono', monospace; padding: 2px 8px; transition: all 0.15s; }
    .copy-btn:hover { color: var(--accent); border-color: var(--accent); }
    .code-body { padding: 14px; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.7; color: #93c5fd; }

    /* Chart */
    .chart-wrap { background: var(--surface); border: 1px solid var(--border2); border-radius: 14px; overflow: hidden; width: 100%; box-shadow: var(--card-shadow); }
    .chart-inner { width: 100%; min-height: 280px; }

    /* Table */
    .table-wrap { background: var(--surface); border: 1px solid var(--border2); border-radius: 14px; overflow: auto; max-height: 260px; width: 100%; box-shadow: var(--card-shadow); }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead { position: sticky; top: 0; }
    th { padding: 10px 14px; text-align: left; background: var(--surface3); color: var(--text2); font-family: 'JetBrains Mono', monospace; font-size: 10px; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); white-space: nowrap; }
    td { padding: 8px 14px; border-bottom: 1px solid var(--border); color: var(--text); white-space: nowrap; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--surface2); }

    /* Error */
    .error-box { background: rgba(244,63,94,0.08); border: 1px solid rgba(244,63,94,0.3); border-radius: 10px; padding: 10px 14px; font-size: 12px; color: var(--danger); font-family: 'JetBrains Mono', monospace; }

    /* Typing */
    .typing { display: flex; gap: 5px; align-items: center; padding: 4px 0; }
    .typing-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--accent); animation: bounce 1.2s infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.15s; background: var(--accent2); }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes bounce { 0%, 60%, 100% { opacity: 0.3; transform: translateY(0); } 30% { opacity: 1; transform: translateY(-4px); } }

    /* Input */
    .input-bar { padding: 14px 20px; border-top: 1px solid var(--border); background: rgba(6,8,16,0.7); backdrop-filter: blur(20px); transition: background var(--transition); }
    [data-theme="light"] .input-bar { background: rgba(255,255,255,0.8); }
    .input-wrap { display: flex; gap: 10px; align-items: flex-end; background: var(--surface); border: 1.5px solid var(--border2); border-radius: 14px; padding: 10px 14px; transition: all 0.2s; box-shadow: var(--card-shadow); }
    .input-wrap:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
    textarea { flex: 1; background: none; border: none; outline: none; resize: none; font-family: 'Space Grotesk', sans-serif; font-size: 14px; color: var(--text); min-height: 22px; max-height: 120px; line-height: 1.5; }
    textarea::placeholder { color: var(--text3); }
    .send-btn {
      width: 38px; height: 38px; border-radius: 10px; border: none; cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: bold; transition: all 0.2s; flex-shrink: 0;
      box-shadow: 0 4px 14px var(--accent-glow); color: white;
    }
    .send-btn:disabled { opacity: 0.3; cursor: not-allowed; box-shadow: none; }
    .send-btn:not(:disabled):hover { transform: scale(1.05); box-shadow: 0 6px 20px var(--accent-glow); }
    .input-hint { text-align: center; font-size: 10px; color: var(--text3); margin-top: 8px; font-family: 'JetBrains Mono', monospace; }

    /* Sidebar toggle mobile */
    .sidebar-toggle { display: none; }

    /* ---- MOBILE ---- */
    @media (max-width: 768px) {
      .header-pill { display: none; }
      .logo-name { font-size: 18px; }
      .app-body { grid-template-columns: 1fr; }
      .sidebar { border-right: none; border-bottom: 1px solid var(--border); max-height: 0; overflow: hidden; transition: max-height 0.35s ease; }
      .sidebar.open { max-height: 70vh; overflow-y: auto; }
      .sidebar-toggle { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; background: var(--surface); border-bottom: 1px solid var(--border); cursor: pointer; font-size: 12px; color: var(--text2); font-family: 'JetBrains Mono', monospace; transition: color 0.2s; }
      .sidebar-toggle:hover { color: var(--accent); }
      .messages { padding: 12px; }
      .msg-content { max-width: 92%; }
      .empty-title { font-size: 26px; }
      .empty-orb { width: 80px; height: 80px; font-size: 36px; }
      .input-bar { padding: 10px 12px; }
      .input-hint { display: none; }
    }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef, useEffect } = React;
const API = "https://datawhisper-backend-e4lv.onrender.com";

function PlotlyChart({ data, theme }) {
  const ref = useRef();
  useEffect(() => {
    if (!ref.current || !data) return;
    const isDark = theme === 'dark';
    const coloredData = data.data.map(trace => ({
      ...trace,
      marker: { ...((trace.marker) || {}), color: trace.marker?.color || '#6366f1', line: { color: '#6366f1', width: 1 } },
      line: { ...((trace.line) || {}), color: trace.line?.color || '#22d3ee' }
    }));
    Plotly.newPlot(ref.current, coloredData, {
      ...data.layout,
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      font: { family: 'Space Grotesk, sans-serif', color: isDark ? '#8b9abd' : '#4a5680', size: 12 },
      margin: { t: 40, r: 20, b: 50, l: 60 },
      colorway: ['#6366f1', '#22d3ee', '#10b981', '#f59e0b', '#f43f5e'],
      xaxis: { gridcolor: isDark ? '#1e2d45' : '#dde3f5', zerolinecolor: isDark ? '#1e2d45' : '#dde3f5' },
      yaxis: { gridcolor: isDark ? '#1e2d45' : '#dde3f5', zerolinecolor: isDark ? '#1e2d45' : '#dde3f5' },
    }, { responsive: true, displayModeBar: false });
    return () => Plotly.purge(ref.current);
  }, [data, theme]);
  return <div ref={ref} className="chart-inner" />;
}

function DataTable({ table }) {
  return (
    <div className="table-wrap">
      <table>
        <thead><tr>{table.columns.map(c => <th key={c}>{c}</th>)}</tr></thead>
        <tbody>{table.rows.map((row, i) => (
          <tr key={i}>{row.map((cell, j) => <td key={j}>{String(cell ?? '')}</td>)}</tr>
        ))}</tbody>
      </table>
    </div>
  );
}

function CodeBlock({ code }) {
  const [show, setShow] = useState(false);
  const [copied, setCopied] = useState(false);
  const copy = (e) => { e.stopPropagation(); navigator.clipboard.writeText(code); setCopied(true); setTimeout(() => setCopied(false), 2000); };
  return (
    <div className="code-block">
      <div className="code-header" onClick={() => setShow(!show)}>
        <span className="code-label">üêç {show ? 'Hide' : 'Show'} Generated Code</span>
        <button className="copy-btn" onClick={copy}>{copied ? '‚úì copied' : show ? 'copy' : '‚ñº'}</button>
      </div>
      {show && <pre className="code-body">{code}</pre>}
    </div>
  );
}

function Message({ msg, theme }) {
  const isUser = msg.role === 'user';
  const clean = (msg.content || '').replace(/Result: Index\(\[.*?\],\s*dtype='[^']*'\)/gs, '').replace(/Result: dtype\([^)]+\)/g, '').trim();
  return (
    <div className={`msg ${isUser ? 'user' : 'ai'}`}>
      <div className="msg-avatar">{isUser ? 'üë§' : 'üåä'}</div>
      <div className="msg-content">
        <div className="msg-bubble">{clean}</div>
        {msg.chart && <div className="chart-wrap"><PlotlyChart data={msg.chart} theme={theme} /></div>}
        {msg.table && <DataTable table={msg.table} />}
        {msg.error && <div className="error-box">‚ö† {msg.error}</div>}
      </div>
    </div>
  );
}

function App() {
  const [session, setSession] = useState(null);
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [uploading, setUploading] = useState(false);
  const [dragOver, setDragOver] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [theme, setTheme] = useState('dark');
  const messagesEnd = useRef();
  const textareaRef = useRef();

  useEffect(() => { document.documentElement.setAttribute('data-theme', theme); }, [theme]);
  useEffect(() => { messagesEnd.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, loading]);

  const toggleTheme = () => setTheme(t => t === 'dark' ? 'light' : 'dark');

  const handleFile = async (file) => {
    if (!file) return;
    setUploading(true);
    const form = new FormData();
    form.append('file', file);
    try {
      const res = await fetch(`${API}/upload`, { method: 'POST', body: form });
      if (!res.ok) { const e = await res.json(); throw new Error(e.detail); }
      const data = await res.json();
      setSession(data); setMessages([]); setSidebarOpen(false);
    } catch (e) { alert('Upload failed: ' + e.message); }
    finally { setUploading(false); }
  };

  const sendMessage = async (text) => {
    const q = (text || input).trim();
    if (!q || !session || loading) return;
    setInput(''); setSidebarOpen(false);
    setMessages(prev => [...prev, { role: 'user', content: q }]);
    setLoading(true);
    try {
      const res = await fetch(`${API}/query`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: session.session_id, question: q }),
      });
      const data = await res.json();
      setMessages(prev => [...prev, { role: 'ai', content: data.answer, code: data.code, chart: data.chart, table: data.table, error: data.error }]);
    } catch (e) {
      setMessages(prev => [...prev, { role: 'ai', content: 'Something went wrong. Please try again.', error: 'Failed to fetch' }]);
    } finally { setLoading(false); }
  };

  const clearChat = () => {
    setMessages([]);
    if (session) fetch(`${API}/session/${session.session_id}`, { method: 'DELETE' });
  };

  const onKeyDown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
  const onInputChange = (e) => { setInput(e.target.value); e.target.style.height = 'auto'; e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px'; };

  const suggestions = [
    'What are the column names and their data types?',
    'How many rows are in this dataset?',
    'How many columns are in this dataset?',
    'Show me a summary of all numeric columns',
    'Show me a bar chart of the data',
  ];

  return (
    <>
      <header>
        <div className="logo">
          <div className="logo-mark">üåä</div>
          <div className="logo-name">Data<em>Whisper</em></div>
        </div>
        <div className="header-right">
          <div className="header-pill">Talk to your CSV / Excel</div>
          <button className="theme-toggle" onClick={toggleTheme} title="Toggle theme">
            {theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}
          </button>
        </div>
      </header>

      <div className="app-body">
        {session && (
          <div className="sidebar-toggle" onClick={() => setSidebarOpen(!sidebarOpen)}>
            <span>{sidebarOpen ? '‚ñ≤ Hide panel' : '‚ñº File & questions'}</span>
            <span style={{color:'var(--accent)', maxWidth:160, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{session.filename}</span>
          </div>
        )}

        <aside className={`sidebar ${sidebarOpen ? 'open' : ''}`}>
          <div className="sidebar-section">
            <div className="sidebar-label">üìÅ Your File</div>
            {!session ? (
              <div className={`upload-zone ${dragOver ? 'drag-over' : ''}`}
                onDragOver={e => { e.preventDefault(); setDragOver(true); }}
                onDragLeave={() => setDragOver(false)}
                onDrop={e => { e.preventDefault(); setDragOver(false); handleFile(e.dataTransfer.files[0]); }}>
                <input type="file" accept=".csv,.xlsx,.xls" onChange={e => handleFile(e.target.files[0])} />
                <span className="upload-icon">{uploading ? '‚è≥' : 'üìä'}</span>
                <div className="upload-title">{uploading ? 'Uploading...' : 'Drop your file here'}</div>
                <div className="upload-sub">CSV, XLSX, XLS supported</div>
              </div>
            ) : (
              <div className="file-info">
                <div className="file-icon-row">
                  <div className="file-dot"></div>
                  <div className="file-name">{session.filename}</div>
                </div>
                <div className="file-meta">
                  <span className="file-tag">{session.rows.toLocaleString()} rows</span>
                  <span className="file-tag">{session.columns} cols</span>
                </div>
                <div className="file-change" onClick={() => setSession(null)}>‚Üê Upload different file</div>
              </div>
            )}
          </div>

          {session && (
            <div className="sidebar-section">
              <div className="sidebar-label">üóÇ Columns</div>
              <div className="col-list">
                {session.column_names.map(col => (
                  <div className="col-item" key={col}>
                    <span className="col-name">{col}</span>
                    <span className="col-badge">col</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {session && (
            <div className="sidebar-section">
              <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'12px'}}>
                <div className="sidebar-label" style={{margin:0}}>üí° Try asking</div>
                <button onClick={clearChat} style={{background:'rgba(244,63,94,0.1)', border:'1px solid rgba(244,63,94,0.3)', borderRadius:'7px', color:'var(--danger)', fontSize:'10px', cursor:'pointer', padding:'4px 10px', fontFamily:'JetBrains Mono, monospace', transition:'all 0.2s'}}>üóë Clear</button>
              </div>
              <div className="suggestions">
                {suggestions.map((s, i) => (
                  <button className="suggestion-btn" key={i} onClick={() => sendMessage(s)}>
                    <span style={{flex:1}}>{s}</span>
                    <span className="suggestion-arrow">‚Üí</span>
                  </button>
                ))}
              </div>
            </div>
          )}
        </aside>

        <div className="chat-area">
          {!session ? (
            <div className="empty-state">
              <div className="empty-orb">üåä</div>
              <div className="empty-title">Ask your data<br/><span>anything</span></div>
              <div className="empty-sub">Upload a CSV or Excel file and start asking questions in plain English. No SQL. No formulas. Just ask.</div>
              <div className={`empty-upload ${dragOver ? 'drag-over' : ''}`}
                onDragOver={e => { e.preventDefault(); setDragOver(true); }}
                onDragLeave={() => setDragOver(false)}
                onDrop={e => { e.preventDefault(); setDragOver(false); handleFile(e.dataTransfer.files[0]); }}>
                <input type="file" accept=".csv,.xlsx,.xls" onChange={e => handleFile(e.target.files[0])} />
                <div className="empty-upload-text">{uploading ? '‚è≥ Uploading...' : 'üìä Click or drop your file here ‚Äî Get started free'}</div>
              </div>
            </div>
          ) : (
            <>
              <div className="messages">
                {messages.length === 0 && (
                  <div style={{textAlign:'center', color:'var(--text3)', fontSize:13, padding:'48px 0', fontFamily:'JetBrains Mono, monospace'}}>
                    ‚úì file loaded ‚Äî ask your first question
                  </div>
                )}
                {messages.map((msg, i) => <Message key={i} msg={msg} theme={theme} />)}
                {loading && (
                  <div className="msg ai">
                    <div className="msg-avatar">üåä</div>
                    <div className="msg-bubble"><div className="typing"><div className="typing-dot"/><div className="typing-dot"/><div className="typing-dot"/></div></div>
                  </div>
                )}
                <div ref={messagesEnd} />
              </div>
              <div className="input-bar">
                <div className="input-wrap">
                  <textarea ref={textareaRef} rows={1} placeholder="Ask anything about your data..." value={input} onChange={onInputChange} onKeyDown={onKeyDown} disabled={loading} />
                  <button className="send-btn" onClick={() => sendMessage()} disabled={loading || !input.trim()}>‚Üë</button>
                </div>
                <div className="input-hint">Enter to send ¬∑ Shift+Enter for new line</div>
              </div>
            </>
          )}
        </div>
      </div>
    </>
  );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>