<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DataWhisper ‚Äî Talk to Your Data</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #080c10; --surface: #0d1117; --surface2: #161b22; --surface3: #1c2128;
      --border: #21262d; --accent: #00e5ff; --accent2: #7c3aed; --accent3: #10b981;
      --text: #e6edf3; --text2: #8b949e; --text3: #484f58; --danger: #f85149; --radius: 12px;
    }
    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif; }
    body::before {
      content: ''; position: fixed; inset: 0; z-index: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none;
    }
    #root { position: relative; z-index: 1; height: 100%; display: flex; flex-direction: column; }

    /* Header */
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 20px; border-bottom: 1px solid var(--border);
      background: rgba(13,17,23,0.9); backdrop-filter: blur(12px);
      position: sticky; top: 0; z-index: 100;
    }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-icon { width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, var(--accent2), var(--accent)); display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .logo-text { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
    .logo-text span { color: var(--accent); }
    .header-badge { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text2); border: 1px solid var(--border); border-radius: 20px; padding: 4px 12px; }

    /* Layout */
    .app-body { flex: 1; display: grid; grid-template-columns: 300px 1fr; overflow: hidden; }

    /* Sidebar */
    .sidebar { border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; background: var(--surface); }
    .sidebar-section { padding: 16px; border-bottom: 1px solid var(--border); }
    .sidebar-label { font-family: 'JetBrains Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text3); margin-bottom: 10px; }

    /* Upload */
    .upload-zone { border: 1.5px dashed var(--border); border-radius: var(--radius); padding: 24px 16px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
    .upload-zone:hover, .upload-zone.drag-over { border-color: var(--accent); background: rgba(0,229,255,0.04); }
    .upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .upload-icon { font-size: 28px; margin-bottom: 8px; }
    .upload-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .upload-sub { font-size: 12px; color: var(--text2); }

    /* File info */
    .file-info { background: var(--surface2); border-radius: var(--radius); padding: 12px; border: 1px solid var(--border); }
    .file-name { font-size: 13px; font-weight: 600; margin-bottom: 6px; word-break: break-all; }
    .file-meta { display: flex; gap: 8px; flex-wrap: wrap; }
    .file-tag { font-family: 'JetBrains Mono', monospace; font-size: 10px; padding: 3px 8px; border-radius: 4px; background: var(--surface3); color: var(--accent); border: 1px solid var(--border); }
    .file-change { margin-top: 10px; font-size: 12px; color: var(--text2); cursor: pointer; text-decoration: underline; text-underline-offset: 3px; }
    .file-change:hover { color: var(--accent); }

    /* Columns */
    .col-list { display: flex; flex-direction: column; gap: 6px; }
    .col-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: var(--surface2); border-radius: 6px; border: 1px solid var(--border); }
    .col-name { font-size: 12px; font-weight: 500; }
    .col-type { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--accent2); }

    /* Suggestions */
    .suggestions { display: flex; flex-direction: column; gap: 6px; }
    .suggestion-btn { text-align: left; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; cursor: pointer; font-size: 12px; color: var(--text2); transition: all 0.2s; font-family: 'Syne', sans-serif; }
    .suggestion-btn:hover { border-color: var(--accent); color: var(--text); background: rgba(0,229,255,0.04); }

    /* Chat */
    .chat-area { display: flex; flex-direction: column; overflow: hidden; background: var(--bg); }
    .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px 20px; }
    .empty-glyph { font-size: 56px; margin-bottom: 16px; filter: drop-shadow(0 0 20px rgba(0,229,255,0.3)); }
    .empty-title { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
    .empty-title span { color: var(--accent); }
    .empty-sub { font-size: 14px; color: var(--text2); max-width: 380px; line-height: 1.6; }

    /* Messages */
    .messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; }
    .messages::-webkit-scrollbar { width: 4px; }
    .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    .msg { display: flex; gap: 10px; animation: fadeSlide 0.3s ease forwards; }
    .msg.user { flex-direction: row-reverse; }
    .msg-avatar { width: 30px; height: 30px; border-radius: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .msg.user .msg-avatar { background: linear-gradient(135deg, var(--accent2), var(--accent)); }
    .msg.ai .msg-avatar { background: var(--surface2); border: 1px solid var(--border); }
    .msg-content { max-width: 80%; display: flex; flex-direction: column; gap: 8px; }
    .msg.user .msg-content { align-items: flex-end; }
    .msg-bubble { padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.6; }
    .msg.user .msg-bubble { background: linear-gradient(135deg, rgba(124,58,237,0.3), rgba(0,229,255,0.15)); border: 1px solid rgba(0,229,255,0.2); }
    .msg.ai .msg-bubble { background: var(--surface); border: 1px solid var(--border); }

    /* Code */
    .code-block { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; width: 100%; }
    .code-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 14px; border-bottom: 1px solid var(--border); background: var(--surface3); cursor: pointer; }
    .code-label { font-family: 'JetBrains Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text2); }
    .copy-btn { font-size: 11px; color: var(--text2); cursor: pointer; background: none; border: none; font-family: 'JetBrains Mono', monospace; padding: 2px 8px; border-radius: 4px; }
    .copy-btn:hover { color: var(--accent); }
    .code-body { padding: 14px; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.7; color: #a5d6ff; }

    /* Chart */
    .chart-container { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; width: 100%; }
    .chart-inner { width: 100%; min-height: 280px; }

    /* Table */
    .table-container { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: auto; max-height: 260px; width: 100%; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead { position: sticky; top: 0; }
    th { padding: 10px 14px; text-align: left; background: var(--surface3); color: var(--text2); font-family: 'JetBrains Mono', monospace; font-size: 11px; border-bottom: 1px solid var(--border); white-space: nowrap; }
    td { padding: 8px 14px; border-bottom: 1px solid var(--border); color: var(--text); white-space: nowrap; }
    tr:hover td { background: var(--surface2); }

    /* Error */
    .error-box { background: rgba(248,81,73,0.08); border: 1px solid rgba(248,81,73,0.3); border-radius: 8px; padding: 10px 14px; font-size: 13px; color: var(--danger); font-family: 'JetBrains Mono', monospace; }

    /* Typing */
    .typing { display: flex; gap: 4px; align-items: center; padding: 12px; }
    .typing-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: pulse 1.2s infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse { 0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); } 30% { opacity: 1; transform: scale(1); } }

    /* Input */
    .input-bar { padding: 12px 16px; border-top: 1px solid var(--border); background: rgba(13,17,23,0.9); backdrop-filter: blur(12px); }
    .input-row { display: flex; gap: 10px; align-items: flex-end; background: var(--surface); border: 1.5px solid var(--border); border-radius: 12px; padding: 10px 14px; transition: border-color 0.2s; }
    .input-row:focus-within { border-color: var(--accent); }
    textarea { flex: 1; background: none; border: none; outline: none; resize: none; font-family: 'Syne', sans-serif; font-size: 14px; color: var(--text); min-height: 22px; max-height: 120px; line-height: 1.5; }
    textarea::placeholder { color: var(--text3); }
    .send-btn { width: 36px; height: 36px; border-radius: 8px; border: none; cursor: pointer; background: linear-gradient(135deg, var(--accent2), var(--accent)); display: flex; align-items: center; justify-content: center; font-size: 16px; transition: opacity 0.2s; flex-shrink: 0; }
    .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .send-btn:not(:disabled):hover { opacity: 0.85; }
    .input-hint { text-align: center; font-size: 11px; color: var(--text3); margin-top: 6px; font-family: 'JetBrains Mono', monospace; }

    /* Mobile toggle button */
    .sidebar-toggle { display: none; }

    @keyframes fadeSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-thumb { background: var(--border); }

    /* ---- MOBILE ---- */
    @media (max-width: 768px) {
      header { padding: 10px 16px; }
      .header-badge { display: none; }
      .logo-text { font-size: 18px; }

      .app-body { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }

      /* Sidebar becomes a collapsible panel on mobile */
      .sidebar {
        border-right: none;
        border-bottom: 1px solid var(--border);
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      .sidebar.open { max-height: 600px; overflow-y: auto; }

      /* Toggle button shown on mobile */
      .sidebar-toggle {
        display: flex; align-items: center; justify-content: space-between;
        padding: 10px 16px; background: var(--surface);
        border-bottom: 1px solid var(--border);
        cursor: pointer; font-size: 13px; color: var(--text2);
        font-family: 'JetBrains Mono', monospace;
      }
      .sidebar-toggle:hover { color: var(--accent); }

      .chat-area { min-height: 0; }
      .messages { padding: 12px; gap: 12px; }
      .msg-content { max-width: 90%; }
      .msg-bubble { font-size: 13px; padding: 8px 12px; }
      .empty-title { font-size: 20px; }
      .empty-sub { font-size: 13px; }
      .empty-glyph { font-size: 48px; }
      .input-bar { padding: 10px 12px; }
      .input-hint { display: none; }
      .chart-inner { min-height: 220px; }
    }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef, useEffect } = React;
const API = "https://datawhisper-backend-e4lv.onrender.com";

function PlotlyChart({ data }) {
  const ref = useRef();
  useEffect(() => {
    if (!ref.current || !data) return;
    const coloredData = data.data.map(trace => ({
      ...trace,
      marker: { ...((trace.marker) || {}), color: trace.marker?.color || '#00e5ff', line: { color: '#00e5ff', width: 1 } },
      line: { ...((trace.line) || {}), color: trace.line?.color || '#00e5ff' }
    }));
    Plotly.newPlot(ref.current, coloredData, {
      ...data.layout,
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(13,17,23,0.8)',
      font: { family: 'Syne, sans-serif', color: '#8b949e' },
      margin: { t: 40, r: 20, b: 60, l: 60 },
      colorway: ['#00e5ff', '#7c3aed', '#10b981', '#f59e0b', '#ef4444'],
    }, { responsive: true, displayModeBar: false });
    return () => Plotly.purge(ref.current);
  }, [data]);
  return <div ref={ref} className="chart-inner" />;
}

function DataTable({ table }) {
  return (
    <div className="table-container">
      <table>
        <thead><tr>{table.columns.map(c => <th key={c}>{c}</th>)}</tr></thead>
        <tbody>{table.rows.map((row, i) => (
          <tr key={i}>{row.map((cell, j) => <td key={j}>{String(cell ?? '')}</td>)}</tr>
        ))}</tbody>
      </table>
    </div>
  );
}

function CodeBlock({ code }) {
  const [show, setShow] = useState(false);
  const [copied, setCopied] = useState(false);
  const copy = (e) => { e.stopPropagation(); navigator.clipboard.writeText(code); setCopied(true); setTimeout(() => setCopied(false), 2000); };
  return (
    <div className="code-block">
      <div className="code-header" onClick={() => setShow(!show)}>
        <span className="code-label">üêç {show ? 'Hide' : 'Show'} Generated Code</span>
        <button className="copy-btn" onClick={copy}>{copied ? '‚úì copied' : show ? 'copy' : '‚ñº'}</button>
      </div>
      {show && <pre className="code-body">{code}</pre>}
    </div>
  );
}

function Message({ msg }) {
  const isUser = msg.role === 'user';
  const clean = (msg.content || '').replace(/Result: Index\(\[.*?\],\s*dtype='[^']*'\)/gs, '').replace(/Result: dtype\([^)]+\)/g, '').trim();
  return (
    <div className={`msg ${isUser ? 'user' : 'ai'}`}>
      <div className="msg-avatar">{isUser ? 'üë§' : 'üåä'}</div>
      <div className="msg-content">
        <div className="msg-bubble">{clean}</div>
        {msg.chart && <div className="chart-container"><PlotlyChart data={msg.chart} /></div>}
        {msg.table && <DataTable table={msg.table} />}
        {msg.error && <div className="error-box">‚ö† {msg.error}</div>}
        {msg.code && <CodeBlock code={msg.code} />}
      </div>
    </div>
  );
}

function App() {
  const [session, setSession] = useState(null);
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [uploading, setUploading] = useState(false);
  const [dragOver, setDragOver] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const messagesEnd = useRef();
  const textareaRef = useRef();

  useEffect(() => { messagesEnd.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, loading]);

  const handleFile = async (file) => {
    if (!file) return;
    setUploading(true);
    const form = new FormData();
    form.append('file', file);
    try {
      const res = await fetch(`${API}/upload`, { method: 'POST', body: form });
      if (!res.ok) { const e = await res.json(); throw new Error(e.detail); }
      const data = await res.json();
      setSession(data); setMessages([]); setSidebarOpen(false);
    } catch (e) { alert('Upload failed: ' + e.message); }
    finally { setUploading(false); }
  };

  const sendMessage = async (text) => {
    const q = (text || input).trim();
    if (!q || !session || loading) return;
    setInput(''); setSidebarOpen(false);
    setMessages(prev => [...prev, { role: 'user', content: q }]);
    setLoading(true);
    try {
      const res = await fetch(`${API}/query`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: session.session_id, question: q }),
      });
      const data = await res.json();
      setMessages(prev => [...prev, { role: 'ai', content: data.answer, code: data.code, chart: data.chart, table: data.table, error: data.error }]);
    } catch (e) {
      setMessages(prev => [...prev, { role: 'ai', content: 'Something went wrong. Please try again.', error: 'Failed to fetch' }]);
    } finally { setLoading(false); }
  };

  const clearChat = () => {
    setMessages([]);
    if (session) fetch(`${API}/session/${session.session_id}`, { method: 'DELETE' });
  };

  const onKeyDown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
  const onInputChange = (e) => { setInput(e.target.value); e.target.style.height = 'auto'; e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px'; };

  const suggestions = [
    'What are the column names and their data types?',
    'How many rows are in this dataset?',
    'How many columns are in this dataset?',
    'Show me a summary of all numeric columns',
    'Show me a bar chart of the data',
  ];

  return (
    <>
      <header>
        <div className="logo">
          <div className="logo-icon">üåä</div>
          <div className="logo-text">Data<span>Whisper</span></div>
        </div>
        <div className="header-badge">Talk to your CSV / Excel</div>
      </header>

      <div className="app-body">
        {/* Mobile toggle */}
        {session && (
          <div className="sidebar-toggle" onClick={() => setSidebarOpen(!sidebarOpen)}>
            <span>{sidebarOpen ? '‚ñ≤ Hide panel' : '‚ñº File & suggestions'}</span>
            <span>{session.filename}</span>
          </div>
        )}

        {/* Sidebar */}
        <aside className={`sidebar ${sidebarOpen ? 'open' : ''}`}>
          <div className="sidebar-section">
            <div className="sidebar-label">üìÅ Your File</div>
            {!session ? (
              <div className={`upload-zone ${dragOver ? 'drag-over' : ''}`}
                onDragOver={e => { e.preventDefault(); setDragOver(true); }}
                onDragLeave={() => setDragOver(false)}
                onDrop={e => { e.preventDefault(); setDragOver(false); handleFile(e.dataTransfer.files[0]); }}>
                <input type="file" accept=".csv,.xlsx,.xls" onChange={e => handleFile(e.target.files[0])} />
                <div className="upload-icon">{uploading ? '‚è≥' : 'üìä'}</div>
                <div className="upload-title">{uploading ? 'Uploading...' : 'Drop your file here'}</div>
                <div className="upload-sub">CSV, XLSX, XLS supported</div>
              </div>
            ) : (
              <div className="file-info">
                <div className="file-name">üìÑ {session.filename}</div>
                <div className="file-meta">
                  <span className="file-tag">{session.rows.toLocaleString()} rows</span>
                  <span className="file-tag">{session.columns} cols</span>
                </div>
                <div className="file-change" onClick={() => setSession(null)}>‚Üê Upload different file</div>
              </div>
            )}
          </div>

          {session && (
            <div className="sidebar-section">
              <div className="sidebar-label">üóÇ Columns</div>
              <div className="col-list">
                {session.column_names.map(col => (
                  <div className="col-item" key={col}>
                    <span className="col-name">{col}</span>
                    <span className="col-type">col</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {session && (
            <div className="sidebar-section">
              <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'10px'}}>
                <div className="sidebar-label" style={{margin:0}}>üí° Try asking</div>
                <button onClick={clearChat} style={{background:'rgba(248,81,73,0.1)', border:'1px solid rgba(248,81,73,0.3)', borderRadius:'6px', color:'#f85149', fontSize:'11px', cursor:'pointer', padding:'3px 10px', fontFamily:'JetBrains Mono, monospace'}}>üóë Clear</button>
              </div>
              <div className="suggestions">
                {suggestions.map((s, i) => (
                  <button className="suggestion-btn" key={i} onClick={() => sendMessage(s)}>{s}</button>
                ))}
              </div>
            </div>
          )}
        </aside>

        {/* Chat */}
        <div className="chat-area">
          {!session ? (
            <div className="empty-state">
              <div className="empty-glyph">üåä</div>
              <div className="empty-title">Ask your data <span>anything</span></div>
              <div className="empty-sub">Upload a CSV or Excel file and start asking questions in plain English. No SQL. No formulas. Just ask.</div>
              <div style={{marginTop:24}}>
                <div className={`upload-zone ${dragOver ? 'drag-over' : ''}`} style={{maxWidth:300, margin:'0 auto'}}
                  onDragOver={e => { e.preventDefault(); setDragOver(true); }}
                  onDragLeave={() => setDragOver(false)}
                  onDrop={e => { e.preventDefault(); setDragOver(false); handleFile(e.dataTransfer.files[0]); }}>
                  <input type="file" accept=".csv,.xlsx,.xls" onChange={e => handleFile(e.target.files[0])} />
                  <div className="upload-icon">{uploading ? '‚è≥' : 'üìä'}</div>
                  <div className="upload-title">{uploading ? 'Uploading...' : 'Drop your file here'}</div>
                  <div className="upload-sub">CSV, XLSX, XLS supported</div>
                </div>
              </div>
            </div>
          ) : (
            <>
              <div className="messages">
                {messages.length === 0 && (
                  <div style={{textAlign:'center', color:'var(--text3)', fontSize:13, padding:'40px 0'}}>
                    File loaded ‚úì ‚Äî Ask your first question below
                  </div>
                )}
                {messages.map((msg, i) => <Message key={i} msg={msg} />)}
                {loading && (
                  <div className="msg ai">
                    <div className="msg-avatar">üåä</div>
                    <div className="msg-bubble"><div className="typing"><div className="typing-dot"/><div className="typing-dot"/><div className="typing-dot"/></div></div>
                  </div>
                )}
                <div ref={messagesEnd} />
              </div>
              <div className="input-bar">
                <div className="input-row">
                  <textarea ref={textareaRef} rows={1} placeholder="Ask anything about your data..." value={input} onChange={onInputChange} onKeyDown={onKeyDown} disabled={loading} />
                  <button className="send-btn" onClick={() => sendMessage()} disabled={loading || !input.trim()}>‚Üë</button>
                </div>
                <div className="input-hint">Enter to send ¬∑ Shift+Enter for new line</div>
              </div>
            </>
          )}
        </div>
      </div>
    </>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>